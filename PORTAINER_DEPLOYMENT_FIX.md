# Исправление ошибки развертывания в Portainer

## Проблема
Ошибка при развертывании стека:
```
compose build operation failed: failed to solve: process "/bin/sh -c apt-get update && apt-get install -y gcc postgresql-client && rm -rf /var/lib/apt/lists/*" did not complete successfully: exit code: 100
```

## Причины
1. Устаревшие индексы пакетов в образе Docker
2. Проблемы с доступом к репозиториям Debian
3. Несоответствие имен переменных окружения

## Решения

### Вариант 1: Использование исправленных файлов

1. Используйте исправленный `Dockerfile` (уже обновлен):
   - Заменен базовый образ на `python:3.11-slim-bullseye`
   - Добавлены флаги `--fix-missing` и `--no-install-recommends`
   - Улучшена очистка кэша

2. Используйте исправленный `.env` файл (уже обновлен):
   - Исправлено имя переменной `SAFETRADE_TELEGRAM_BOT_TOKEN` на `TELEGRAM_BOT_TOKEN`

### Вариант 2: Использование альтернативных файлов

Если основной вариант не сработает, используйте альтернативные файлы:
- `Dockerfile.alternative` - более стабильный базовый образ
- `docker-compose.alternative.yml` - конфигурация с использованием альтернативного Dockerfile

### Вариант 3: Развертывание с альтернативными файлами в Portainer

1. В Portainer выберите "Stacks"
2. Нажмите "Add stack"
3. В поле "Name" введите имя вашего стека
4. В поле "Web editor" вставьте содержимое `docker-compose.alternative.yml`
5. Убедитесь, что в разделе "Environment" настроены все переменные из `.env` файла
6. Нажмите "Deploy the stack"

### Вариант 4: Локальное тестирование

Перед развертыванием в Portainer можно протестировать локально:

```bash
# Используя основной Dockerfile
docker-compose build

# Или используя альтернативный
docker-compose -f docker-compose.alternative.yml build
```

### Вариант 5: Очистка кэша Docker

Если проблема сохраняется, попробуйте очистить кэш Docker:

```bash
# Очистка кэша сборки
docker builder prune -a

# Очистка неиспользуемых образов и контейнеров
docker system prune -a
```

## Дополнительные рекомендации

1. Убедитесь, что у вас стабильное интернет-соединение
2. Проверьте, что все переменные окружения в `.env` файле корректны
3. Если проблема связана с сетью, попробуйте развернуть в другое время
4. В Portainer можно включить детальные логи сборки для получения дополнительной информации

## Проверка работоспособности

После успешного развертывания проверьте логи контейнера:

```bash
docker logs safetrade
```

Если контейнер работает корректно, вы должны увидеть сообщения о запуске бота и подключении к сервисам.