# Инструкция по развертыванию SafeTrade Bot в Portainer

## Раздел 1: Настройка переменных окружения (Environment Variables)

Бот не запустится без API-ключей и токенов. Обязательно настройте следующие переменные:

### Обязательные переменные:

- **SAFETRADE_API_KEY** - API ключ для доступа к SafeTrade
- **SAFETRADE_API_SECRET** - API секрет для доступа к SafeTrade
- **SUPABASE_URL** - URL базы данных Supabase
- **SUPABASE_KEY** - Ключ доступа к Supabase
- **TELEGRAM_BOT_TOKEN** - Токен Telegram бота
- **ADMIN_CHAT_ID** - ID чата администратора для уведомлений

### Как добавить переменные в Portainer:

1. При создании или редактировании стека/контейнера найдите раздел **"Environment variables"**
2. Нажмите **"Add environment variable"**
3. Введите имя переменной (например, `SAFETRADE_API_KEY`) и ее значение
4. Повторите для всех переменных из списка

### Опциональные переменные:

- **CEREBRAS_API_KEY** - API ключ для ИИ-помощника Cerebras (если используется)

## Раздел 2: Настройка сети (Networking)

Контейнеры иногда не могут связаться с внешним миром из-за проблем с DNS.

### Решение проблем с DNS:

1. При создании/редактировании контейнера перейдите на вкладку **"Network"**
2. В поле **"DNS servers"** добавьте следующие IP-адреса, каждый с новой строки:
   ```
   8.8.8.8
   1.1.1.1
   ```
3. Это обеспечит стабильное разрешение доменных имен для Telegram, SafeTrade и Supabase

### Настройка портов:

- Убедитесь, что порт **8443** доступен и проброшен (если используется webhook режим)

## Раздел 3: Проверка логов

Если бот все равно не работает, выполните следующие действия:

### Проверка статуса контейнера:

1. В Portainer найдите ваш контейнер
2. Проверьте его статус:
   - **Running** (зеленый) - контейнер работает
   - **Unhealthy** (желтый) - проблемы со здоровьем
   - **Stopped** (красный) - контейнер остановлен

### Анализ логов:

1. Нажмите на иконку **"Logs"** рядом с контейнером
2. Ищите сообщения об ошибках (ERROR)
3. Чаще всего ошибка будет связана с:
   - Неверным API-ключом
   - Сетевой недоступностью
   - Отсутствующими переменными окружения

### Типичные ошибки и решения:

**Ошибка:** `❌ Отсутствуют обязательные переменные окружения`
- **Решение:** Проверьте, что все переменные из раздела 1 настроены

**Ошибка:** `❌ Ошибка подключения к Supabase`
- **Решение:** Проверьте URL и ключ Supabase

**Ошибка:** `❌ Сетевая ошибка`
- **Решение:** Настройте DNS сервера как в разделе 2

## Раздел 4: Процесс развертывания

### Шаг 1: Подготовка

1. Убедитесь, что у вас есть все API ключи и токены
2. Проверьте, что код загружен в Git репозиторий

### Шаг 2: Создание стека в Portainer

1. Откройте Portainer
2. Перейдите в раздел **"Stacks"**
3. Нажмите **"Add stack"**
4. Введите имя стека (например, `safetrade-bot`)
5. В поле **"Web editor"** вставьте содержимое `docker-compose.yml`:

```yaml
version: '3.8'

services:
  safetrade:
    image: your-registry/safetrade:latest
    container_name: safetrade
    restart: unless-stopped
    environment:
      - SAFETRADE_API_KEY=${SAFETRADE_API_KEY}
      - SAFETRADE_API_SECRET=${SAFETRADE_API_SECRET}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - CEREBRAS_API_KEY=${CEREBRAS_API_KEY}
      - ADMIN_CHAT_ID=${ADMIN_CHAT_ID}
    ports:
      - "8443:8443"
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
```

### Шаг 3: Настройка переменных окружения

1. В разделе **"Environment"** добавьте все переменные из раздела 1
2. Проверьте правильность значений

### Шаг 4: Настройка сети

1. Перейдите на вкладку **"Network"**
2. Добавьте DNS сервера: `8.8.8.8` и `1.1.1.1`

### Шаг 5: Развертывание

1. Нажмите **"Deploy the stack"**
2. Дождитесь завершения развертывания
3. Проверьте статус контейнера

## Раздел 5: Проверка работоспособности

### После развертывания:

1. Проверьте логи контейнера на наличие ошибок
2. Убедитесь, что контейнер имеет статус **"healthy"**
3. Отправьте команду `/start` вашему Telegram боту
4. Проверьте, что бот отвечает на команды

### Если бот не отвечает:

1. Проверьте логи на наличие ошибок аутентификации
2. Убедитесь, что `TELEGRAM_BOT_TOKEN` правильный
3. Проверьте, что `ADMIN_CHAT_ID` указан верно

## Раздел 6: Обновление

### Для обновления бота:

1. В Portainer найдите ваш стек
2. Нажмите **"Edit"**
3. Обновите образ (если нужно)
4. Нажмите **"Update the stack"**

### Для перезапуска:

1. Остановите контейнер: **"Stop"**
2. Запустите контейнер: **"Start"**

## Раздел 7: Поддержка

### Полезные команды:

- **Проверка переменных окружения:** `python main.py env`
- **Проверка здоровья БД:** `python main.py health`
- **Очистка БД:** `python main.py cleanup`

### Где получить помощь:

1. Проверьте логи контейнера в Portainer
2. Ознакомьтесь с документацией в репозитории
3. Проверьте статус API SafeTrade и Telegram

---

**Важно:** Всегда храните API ключи в безопасности и никогда не передавайте их третьим лицам!